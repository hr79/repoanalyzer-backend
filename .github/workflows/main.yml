name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.github/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.github/**'

jobs:
  # =================== CI ===================
  build:
    runs-on: ubuntu-latest

    env:
      REGISTRY: ${{ secrets.DOCKER_REGISTRY_URL }}
      IMAGE_NAME: project-ai-analyzer
      IMAGE_TAG: latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: gradle-

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Tests
        run: ./gradlew test --info

      - name: Build Backend Jar
        run: ./gradlew clean build -x test

      # push main일 때만 Docker build/push 수행
      - name: Build and Push Docker Image
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          IMAGE=$REGISTRY/$IMAGE_NAME:$IMAGE_TAG
          docker login $REGISTRY -u "${{ secrets.PROD_DOCKER_USERNAME }}" -p "${{ secrets.PROD_DOCKER_PASSWORD }}"
          docker build -t $IMAGE .
          docker push $IMAGE


  # =================== CD ===================
  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    env:
      REGISTRY: ${{ secrets.DOCKER_REGISTRY_URL }}
      IMAGE_NAME: project-ai-analyzer
      IMAGE_TAG: latest

    steps:
      - name: Deploy to Naver Cloud
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.NCLOUD_SERVER_IP }}
          username: ${{ secrets.NCLOUD_SERVER_USER }}
          key: ${{ secrets.NCLOUD_PRIVATE_KEY }}
          script: |
            cd /home/${{ secrets.NCLOUD_SERVER_USER }}
            sudo docker compose -f docker-compose.prod.yml down
            sudo docker pull $REGISTRY/$IMAGE_NAME:$IMAGE_TAG
            sudo docker compose -f docker-compose.prod.yml up -d --force-recreate

      - name: Smoke Test - Backend Health
        run: |
          for i in {1..10}; do
            curl -fsS https://praianalyzer.duckdns.org/api/actuator/health && exit 0
            echo "Backend not ready... retrying"
            sleep 5
          done
          exit 1
